const locationData = {
    "data": [
        {
            "East Side Rainfall": {
                "city": "East Side Rainfall",
                "currentLevels": 7.1,
                "lat": 42.06949932995881,
                "lng": -87.77125931992899,
                "previousData": [
                    {
                        "riseLevel": 617.816329121697,
                        "timestamp": "2025-03-10 17:34:07.000"
                    },
                    {
                        "riseLevel": 617.8005685791585,
                        "timestamp": "2025-03-10 17:44:07.000"
                    },
                    {
                        "riseLevel": 617.7968639087828,
                        "timestamp": "2025-03-10 17:54:07.000"
                    },
                    {
                        "riseLevel": 617.8182958942158,
                        "timestamp": "2025-03-10 18:04:07.000"
                    },
                    {
                        "riseLevel": 617.7907324942619,
                        "timestamp": "2025-03-10 17:34:13.000"
                    },
                    {
                        "riseLevel": 617.808560868351,
                        "timestamp": "2025-03-10 17:44:13.000"
                    },
                    {
                        "riseLevel": 617.801647431719,
                        "timestamp": "2025-03-10 17:54:13.000"
                    },
                    {
                        "riseLevel": 617.7849409968381,
                        "timestamp": "2025-03-10 18:04:13.000"
                    },
                    {
                        "riseLevel": 617.818783519561,
                        "timestamp": "2025-03-10 17:35:21.000"
                    },
                    {
                        "riseLevel": 617.8045006505281,
                        "timestamp": "2025-03-10 17:45:21.000"
                    },
                    {
                        "riseLevel": 617.7883413806856,
                        "timestamp": "2025-03-10 17:55:21.000"
                    },
                    {
                        "riseLevel": 617.8198698059939,
                        "timestamp": "2025-03-10 18:05:21.000"
                    },
                    {
                        "riseLevel": 617.7882270160505,
                        "timestamp": "2025-03-10 17:36:58.000"
                    },
                    {
                        "riseLevel": 617.8178343059597,
                        "timestamp": "2025-03-10 17:46:58.000"
                    },
                    {
                        "riseLevel": 617.7981843695584,
                        "timestamp": "2025-03-10 17:56:58.000"
                    },
                    {
                        "riseLevel": 617.7951400370645,
                        "timestamp": "2025-03-10 18:06:58.000"
                    }
                ]
            }
        },
        {
            "Service Center Rainfall": {
                "city": "Service Center Rainfall",
                "currentLevels": 6.7,
                "lat": 42.07907923834326,
                "lng": -87.8214062215235,
                "previousData": [
                    {
                        "riseLevel": 617.7928784869956,
                        "timestamp": "2025-03-10 17:34:07.000"
                    },
                    {
                        "riseLevel": 617.8094918085478,
                        "timestamp": "2025-03-10 17:44:07.000"
                    },
                    {
                        "riseLevel": 617.7886344425672,
                        "timestamp": "2025-03-10 17:54:07.000"
                    },
                    {
                        "riseLevel": 617.8140634265911,
                        "timestamp": "2025-03-10 18:04:07.000"
                    },
                    {
                        "riseLevel": 617.8075789101331,
                        "timestamp": "2025-03-10 17:34:13.000"
                    },
                    {
                        "riseLevel": 617.794286241521,
                        "timestamp": "2025-03-10 17:44:13.000"
                    },
                    {
                        "riseLevel": 617.8073618901697,
                        "timestamp": "2025-03-10 17:54:13.000"
                    },
                    {
                        "riseLevel": 617.8108713159314,
                        "timestamp": "2025-03-10 18:04:13.000"
                    },
                    {
                        "riseLevel": 617.7952624567164,
                        "timestamp": "2025-03-10 17:35:21.000"
                    },
                    {
                        "riseLevel": 617.8164916761332,
                        "timestamp": "2025-03-10 17:45:21.000"
                    },
                    {
                        "riseLevel": 617.8100253357002,
                        "timestamp": "2025-03-10 17:55:21.000"
                    },
                    {
                        "riseLevel": 617.8086954003203,
                        "timestamp": "2025-03-10 18:05:21.000"
                    },
                    {
                        "riseLevel": 617.7983998765966,
                        "timestamp": "2025-03-10 17:36:58.000"
                    },
                    {
                        "riseLevel": 617.7902058278388,
                        "timestamp": "2025-03-10 17:46:58.000"
                    },
                    {
                        "riseLevel": 617.806511405059,
                        "timestamp": "2025-03-10 17:56:58.000"
                    },
                    {
                        "riseLevel": 617.811880155298,
                        "timestamp": "2025-03-10 18:06:58.000"
                    }
                ]
            }
        },
        {
            "Techny Basin Reservoir Level": {
                "city": "Techny Basin Reservoir Level",
                "currentLevels": 6.1,
                "lat": 42.097692466267624,
                "lng": -87.80849209109142,
                "previousData": [
                    {
                        "riseLevel": 617.798289093598,
                        "timestamp": "2025-03-10 17:34:07.000"
                    },
                    {
                        "riseLevel": 617.8078760871747,
                        "timestamp": "2025-03-10 17:44:07.000"
                    },
                    {
                        "riseLevel": 617.7834806433531,
                        "timestamp": "2025-03-10 17:54:07.000"
                    },
                    {
                        "riseLevel": 617.7881401088873,
                        "timestamp": "2025-03-10 18:04:07.000"
                    },
                    {
                        "riseLevel": 617.7894829972394,
                        "timestamp": "2025-03-10 17:34:13.000"
                    },
                    {
                        "riseLevel": 617.7865350629945,
                        "timestamp": "2025-03-10 17:44:13.000"
                    },
                    {
                        "riseLevel": 617.798410245789,
                        "timestamp": "2025-03-10 17:54:13.000"
                    },
                    {
                        "riseLevel": 617.7943941974662,
                        "timestamp": "2025-03-10 18:04:13.000"
                    },
                    {
                        "riseLevel": 617.7962828046548,
                        "timestamp": "2025-03-10 17:35:21.000"
                    },
                    {
                        "riseLevel": 617.7911326590204,
                        "timestamp": "2025-03-10 17:45:21.000"
                    },
                    {
                        "riseLevel": 617.8056844546537,
                        "timestamp": "2025-03-10 17:55:21.000"
                    },
                    {
                        "riseLevel": 617.7869725123002,
                        "timestamp": "2025-03-10 18:05:21.000"
                    },
                    {
                        "riseLevel": 617.7928542198008,
                        "timestamp": "2025-03-10 17:36:58.000"
                    },
                    {
                        "riseLevel": 617.8197549810411,
                        "timestamp": "2025-03-10 17:46:58.000"
                    },
                    {
                        "riseLevel": 617.8155256763001,
                        "timestamp": "2025-03-10 17:56:58.000"
                    },
                    {
                        "riseLevel": 617.7927980818758,
                        "timestamp": "2025-03-10 18:06:58.000"
                    }
                ]
            }
        },
        {
            "West Fork of the chicago River's North Branch": {
                "city": "West Fork of the chicago River's North Branch",
                "currentLevels": 6.5,
                "lat": 42.1708866058241,
                "lng": -87.84745483998773,
                "previousData": [
                    {
                        "riseLevel": 617.8177092247267,
                        "timestamp": "2025-03-10 17:44:07.000"
                    },
                    {
                        "riseLevel": 617.7967390526416,
                        "timestamp": "2025-03-10 17:54:07.000"
                    },
                    {
                        "riseLevel": 617.8034362271342,
                        "timestamp": "2025-03-10 18:04:07.000"
                    },
                    {
                        "riseLevel": 617.8005700572284,
                        "timestamp": "2025-03-10 17:34:13.000"
                    },
                    {
                        "riseLevel": 617.8110009579707,
                        "timestamp": "2025-03-10 17:44:13.000"
                    },
                    {
                        "riseLevel": 617.7847213190041,
                        "timestamp": "2025-03-10 17:54:13.000"
                    },
                    {
                        "riseLevel": 617.8099952192541,
                        "timestamp": "2025-03-10 18:04:13.000"
                    },
                    {
                        "riseLevel": 617.7818607783893,
                        "timestamp": "2025-03-10 17:35:21.000"
                    },
                    {
                        "riseLevel": 617.7877963356408,
                        "timestamp": "2025-03-10 17:45:21.000"
                    },
                    {
                        "riseLevel": 617.7874959759033,
                        "timestamp": "2025-03-10 17:55:21.000"
                    },
                    {
                        "riseLevel": 617.8185497565692,
                        "timestamp": "2025-03-10 18:05:21.000"
                    },
                    {
                        "riseLevel": 617.7955487099515,
                        "timestamp": "2025-03-10 17:36:58.000"
                    },
                    {
                        "riseLevel": 617.7840431316856,
                        "timestamp": "2025-03-10 17:46:58.000"
                    },
                    {
                        "riseLevel": 617.7944747932023,
                        "timestamp": "2025-03-10 17:56:58.000"
                    },
                    {
                        "riseLevel": 617.8189729153398,
                        "timestamp": "2025-03-10 18:06:58.000"
                    }
                ]
            }
        }
    ]
}


// const transformedData = {};
// sampleData.data.forEach(item => {
//     const locationName = Object.keys(item)[0];
//     transformedData[locationName] = item[locationName];
// });
// console.log(transformedData); 

// Store the markers for later reference
const markers = [];
let map;
let infoWindow;
let originalLocationData = null;
let currentFilter = 'today'; // Default filter

// Store the currently active location for info panel updates
let activeLocationInfo = null;
// Keep track of the last clicked location key
let activeLocationKey = null;

// Initialize Google Maps
function initMap() {

    originalLocationData = JSON.parse(JSON.stringify(locationData));

    // Find average lat/lng for centering the map
    let totalLat = 0;
    let totalLng = 0;
    let count = 0;
    
    locationData.data.forEach(location => {
        const locationKey = Object.keys(location)[0];
        const locationInfo = location[locationKey];
        totalLat += locationInfo.lat;
        totalLng += locationInfo.lng;
        count++;
    });
    
    const avgLat = totalLat / count;
    const avgLng = totalLng / count;
    
    // Create the map
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: avgLat, lng: avgLng },
        zoom: 12,
        styles: [
            {
                featureType: "water",
                elementType: "geometry",
                stylers: [
                    { color: "#e9e9e9" },
                    { lightness: 17 }
                ]
            },
            {
                featureType: "landscape",
                elementType: "geometry",
                stylers: [
                    { color: "#f5f5f5" },
                    { lightness: 20 }
                ]
            }
        ]
    });
    
    // Create info window for markers
    infoWindow = new google.maps.InfoWindow();

    // Initialize with the default filter (today)
    updateMap();
    
    // Set up filter button click handlers
    setupFilterButtons();
    
    // // Add markers for each location
    // locationData.data.forEach(location => {
    //     const locationKey = Object.keys(location)[0];
    //     const locationInfo = location[locationKey];
        
    //     // Determine marker color based on current level
    //     const markerColor = getMarkerColor(locationInfo.currentLevels);
        
    //     // Create marker
    //     const marker = new google.maps.Marker({
    //         position: { lat: locationInfo.lat, lng: locationInfo.lng },
    //         map: map,
    //         title: locationInfo.city,
    //         icon: {
    //             path: google.maps.SymbolPath.CIRCLE,
    //             fillColor: markerColor,
    //             fillOpacity: 0.9,
    //             strokeWeight: 1,
    //             strokeColor: "#ffffff",
    //             scale: 12
    //         }
    //     });
        
    //     markers.push(marker);
        
    //     // Add click listener to marker
    //     marker.addListener("click", () => {
    //         showInfoPanel(locationInfo);
            
    //         // Show small info window on marker
    //         infoWindow.setContent(`
    //             <div style="font-weight: bold;">${locationInfo.city}</div>
    //             <div>Current Level: ${locationInfo.currentLevels} ft</div>
    //         `);
    //         infoWindow.open(map, marker);
    //     });
    // });
}

// Function to set up filter button click handlers
function setupFilterButtons() {
    const filterButtons = document.querySelectorAll('.weather-filters button');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Skip if already active
            if (this.classList.contains('btn-primary')) {
                return;
            }

            // Remove active class from all buttons
            filterButtons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-link');
            });
            
            // Add active class to clicked button
            this.classList.remove('btn-link');
            this.classList.add('btn-primary');
            
            // Get filter type and update map
            const filterType = this.getAttribute('data-filter');
            currentFilter = filterType;
            updateMap();

            // // Also update the infoWindow content if it's open
            // if (infoWindow.getMap() !== null && infoWindow.getMap() !== undefined) {
            //     const marker = markers.find(m => m.getTitle() === activeLocationInfo?.city);
            //     if (marker) {
            //         infoWindow.setContent(`
            //             <div style="font-weight: bold;">${activeLocationInfo.city}</div>
            //             <div>Current Level: ${activeLocationInfo.currentLevels} ft</div>
            //             <div>Filter: ${capitalizeFirstLetter(currentFilter)}</div>
            //         `);
            //     }
            // }
        });
    });
}

// Function to update map based on selected filter
function updateMap() {
    // Clear existing markers
    markers.forEach(marker => marker.setMap(null));
    markers.length = 0;
    
    // Close the info window but don't reset activeLocationKey
    // so we can reopen the panel with updated data
    infoWindow.close();
    
    // Clone the original data to work with
    const filteredData = JSON.parse(JSON.stringify(originalLocationData));
    
    // Apply filter to the data
    filteredData.data.forEach(location => {
        const locationKey = Object.keys(location)[0];
        const locationInfo = location[locationKey];
        
        // Filter the previousData based on the selected time frame
        locationInfo.previousData = filterDataByTimeFrame(locationInfo.previousData, currentFilter);
    });
    
    // Add markers for each location with filtered data
    filteredData.data.forEach(location => {
        const locationKey = Object.keys(location)[0];
        const locationInfo = location[locationKey];
        
        // Determine marker color based on current level
        const markerColor = getMarkerColor(locationInfo.currentLevels);
        
        // Create marker
        const marker = new google.maps.Marker({
            position: { lat: locationInfo.lat, lng: locationInfo.lng },
            map: map,
            title: locationInfo.city,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: markerColor,
                fillOpacity: 0.9,
                strokeWeight: 1,
                strokeColor: "#ffffff",
                scale: 12
            }
        });
        
        markers.push(marker);
        
        // Add click listener to marker
        marker.addListener("click", () => {
            // Update active location tracking
            activeLocationInfo = locationInfo;
            activeLocationKey = locationKey;
            
            // Show the info panel
            showInfoPanel(locationInfo);
            
            // Show small info window on marker
            infoWindow.setContent(`
                <div style="font-weight: bold;">${locationInfo.city}</div>
                <div>Current Level: ${locationInfo.currentLevels} ft</div>
                <div>Filter: ${capitalizeFirstLetter(currentFilter)}</div>
            `);
            infoWindow.open(map, marker);
        });
        
        // If this location matches our active location, update its info panel
        if (activeLocationKey === locationKey) {
            activeLocationInfo = locationInfo;
            // Only update if the info panel is currently visible
            if (document.getElementById("info-panel").classList.contains("active")) {
                showInfoPanel(locationInfo);
            }
        }
    });
}

// Helper function to filter data by time frame
function filterDataByTimeFrame(data, timeFrame) {
    if (!data || data.length === 0) return [];
    
    const now = new Date();
    let filteredData = [];
    
    switch (timeFrame) {
        case 'hourly':
            // Get data from the last hour
            const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
            filteredData = data.filter(item => new Date(item.timestamp) >= oneHourAgo);
            break;
            
        case 'today':
            // Get data from today (midnight to now)
            const today = new Date(now.setHours(0, 0, 0, 0));
            filteredData = data.filter(item => new Date(item.timestamp) >= today);
            break;
            
        case 'weekly':
            // Get data from the last 7 days
            const oneWeekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
            filteredData = data.filter(item => new Date(item.timestamp) >= oneWeekAgo);
            break;
            
        case 'monthly':
            // Get data from the last 30 days
            const oneMonthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            filteredData = data.filter(item => new Date(item.timestamp) >= oneMonthAgo);
            break;
            
        default:
            filteredData = data;
            break;
    }
    
    return filteredData;
}

// Get color for marker based on level
function getMarkerColor(level) {
    if (level >= 7.0) {
        return "#FF0000"; // Red for high levels
    } else if (level >= 6.5) {
        return "#FFA500"; // Orange for medium-high levels
    } else if (level >= 6.0) {
        return "#FFFF00"; // Yellow for medium levels
    } else {
        return "#00FF00"; // Green for low levels
    }
}

// Show info panel with location details
function showInfoPanel(locationInfo) {
    // Sort previous data by timestamp
    const sortedData = [...locationInfo.previousData].sort((a, b) => {
        return new Date(a.timestamp) - new Date(b.timestamp);
    });
    
    // Format data for display
    const formattedData = sortedData.map(item => {
        const date = new Date(item.timestamp);
        return {
            time: `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`,
            level: item.riseLevel
        };
    });
    
    // Get the most recent timestamp
    const lastUpdate = sortedData.length > 0 ? 
        new Date(sortedData[sortedData.length - 1].timestamp).toLocaleString() : 
        "Unknown";

    // Create a message if no data is available for the current filter
    const noDataMessage = sortedData.length === 0 ? 
        `<div class="alert alert-info">No data available for ${capitalizeFirstLetter(currentFilter)} filter.</div>` : '';
    
    // Create HTML content for info panel
    const infoContent = `
        <h2 class="info-header">${locationInfo.city}</h2>
        
        <div class="info-section">
            <div class="info-label">Current Water Level</div>
            <div class="current-level">${locationInfo.currentLevels} ft</div>
            <div class="timestamp">Last Updated: ${lastUpdate}</div>
            <div class="filter-type">Filter: ${capitalizeFirstLetter(currentFilter)}</div>
        </div>
        
        <div class="info-section">
            <div class="info-label">Location</div>
            <div>Latitude: ${locationInfo.lat.toFixed(6)}</div>
            <div>Longitude: ${locationInfo.lng.toFixed(6)}</div>
        </div>
        
        <div class="info-section">
            <div class="info-label">Water Level History (${capitalizeFirstLetter(currentFilter)})</div>
            ${noDataMessage}
            <div class="data-chart" id="chart-container" ${sortedData.length === 0 ? 'style="display:none;"' : ''}></div>
        </div>
        
        <div class="info-section" ${sortedData.length === 0 ? 'style="display:none;"' : ''}>
            <div class="info-label">Raw Data (Recent)</div>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background-color: #f2f2f2;">
                    <th style="text-align: left; padding: 8px; border: 1px solid #ddd;">Time</th>
                    <th style="text-align: right; padding: 8px; border: 1px solid #ddd;">Level (ft)</th>
                </tr>
                ${sortedData.slice(-5).reverse().map(item => {
                    const date = new Date(item.timestamp);
                    return `
                        <tr>
                            <td style="text-align: left; padding: 8px; border: 1px solid #ddd;">
                                ${date.toLocaleString()}
                            </td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #ddd;">
                                ${item.riseLevel.toFixed(2)}
                            </td>
                        </tr>
                    `;
                }).join('')}
            </table>
        </div>
    `;
    
    // Update and show info panel
    document.getElementById("info-content").innerHTML = infoContent;
    document.getElementById("info-panel").classList.add("active");
    
    // Draw simple line chart
    if (sortedData.length > 0) {
        setTimeout(() => {
            drawChart(formattedData);
        }, 100);
    }
}

// Helper function to capitalize first letter
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// Close info panel
function closeInfoPanel() {
    document.getElementById("info-panel").classList.remove("active");
    infoWindow.close();
    // Reset active location tracking
    activeLocationInfo = null;
    activeLocationKey = null;
}

// Draw simple line chart with canvas
function drawChart(data) {
    const canvas = document.createElement("canvas");
    const container = document.getElementById("chart-container");
    container.innerHTML = "";
    container.appendChild(canvas);
    
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    
    const ctx = canvas.getContext("2d");
    const padding = 40;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;
    
    // Get min and max values for scaling
    const values = data.map(item => item.level);
    const minValue = Math.min(...values) - 0.01; // Small offset for better visualization
    const maxValue = Math.max(...values) + 0.01;
    
    // Draw background and grid
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw axes
    ctx.strokeStyle = "#999999";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, padding + chartHeight);
    ctx.lineTo(padding + chartWidth, padding + chartHeight);
    ctx.stroke();
    
    // Draw grid lines
    ctx.strokeStyle = "#eeeeee";
    ctx.lineWidth = 1;
    
    // Horizontal grid lines
    const numGridLines = 5;
    for (let i = 0; i <= numGridLines; i++) {
        const y = padding + (chartHeight / numGridLines) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(padding + chartWidth, y);
        ctx.stroke();
        
        // Draw labels
        const label = (maxValue - ((maxValue - minValue) / numGridLines * i)).toFixed(3);
        ctx.fillStyle = "#666666";
        ctx.font = "10px Arial";
        ctx.textAlign = "right";
        ctx.fillText(label, padding - 5, y + 3);
    }
    
    // Draw line chart
    ctx.strokeStyle = "#3498db";
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    data.forEach((point, index) => {
        const x = padding + (chartWidth / (data.length - 1)) * index;
        const y = padding + chartHeight - ((point.level - minValue) / (maxValue - minValue) * chartHeight);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
        
        // Draw data point
        ctx.fillStyle = "#3498db";
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw labels on x-axis for some points
        if (index % Math.ceil(data.length / 5) === 0 || index === data.length - 1) {
            ctx.fillStyle = "#666666";
            ctx.font = "10px Arial";
            ctx.textAlign = "center";
            ctx.fillText(point.time, x, padding + chartHeight + 15);
        }
    });
    
    ctx.stroke();
    
    // Draw chart title
    ctx.fillStyle = "#333333";
    ctx.font = "12px Arial";
    ctx.textAlign = "center";
    ctx.fillText("Water Level Fluctuation", canvas.width / 2, 15);
}

initMap();